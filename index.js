const t=(t,e,r)=>{const n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttributeNS(null,"x1",t.x.toString()),n.setAttributeNS(null,"y1",t.y.toString()),n.setAttributeNS(null,"x2",e.x.toString()),n.setAttributeNS(null,"y2",e.y.toString()),n.setAttributeNS(null,"stroke",r),n.setAttributeNS(null,"stroke-width","1%"),n},e=e=>{const r=e.getAttribute("viewBox");if(null===r)throw new Error("svg element has no viewBox");const[,,n,s]=r.split(" ").map((t=>parseInt(t,10)));e.appendChild(t({x:n/2,y:0},{x:n/2,y:s},"#DDD")),e.appendChild(t({x:0,y:s/2},{x:n,y:s/2},"#DDD"))},r=t=>{const e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttributeNS(null,"d",t),Math.ceil(e.getTotalLength())},n=async t=>{const e=`https://cdn.jsdelivr.net/npm/hanzi-writer-data/${t}.json`,n=await fetch(e,{cache:"no-store"}),s=await n.json(),o=[];for(let t=0;t<Math.min(s.strokes.length,s.medians.length);t+=1){const e=s.medians[t].map(((t,e)=>[0===e?"M":"L",t[0].toString(),t[1].toString()].join(" "))).join(" ");o.push({clipPath:s.strokes[t],strokePath:e,strokePathLength:r(e)})}return{character:t,strokeWidth:128,strokes:o,transform:"scale(1, -1) translate(0, -900)",type:"zh",viewBox:"0 0 1024 1024"}},s=async t=>{const e=t.codePointAt(0)?.toString(16).padStart(5,"0");if(void 0===e)throw new Error("characterCode is undefined!");const n=`https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${`${e}.svg`}`,s=await fetch(n,{cache:"no-store"}),o=await s.text(),i=(new DOMParser).parseFromString(o,"image/svg+xml"),a=i.querySelector("svg")?.getAttribute("viewBox");if(null==a)throw new Error("viewBox is null or undefined!");const u=Array.from(i.querySelectorAll("path")).sort(((t,e)=>{const[r,n]=[t,e].map((t=>{const e=t.getAttribute("id");if(null===e)throw new Error("id is null!");return parseInt(e.substring(e.indexOf("-s")),10)}));return r-n})).map((t=>{const e=t.getAttribute("d");if(null===e)throw new Error("d is null!");return e})).map((t=>({clipPath:null,strokePath:t,strokePathLength:r(t)}))),l=Array.from(i.querySelectorAll("g[style]")).map((t=>parseFloat(t.style.getPropertyValue("stroke-width")))).find((t=>!isNaN(t)&&isFinite(t)));if(void 0===l)throw new Error("strokeWidth is undefined!");return{character:t,strokeWidth:l,strokes:u,transform:null,type:"ja",viewBox:a}},o=t=>{const{pauseRatio:e,totalStrokeDuration:r}=t;if(isNaN(e))throw new RangeError("pauseRatio is NaN!");if(e<0)throw new RangeError("pauseRatio cannot be < 0!");if(e>=1)throw new RangeError("pauseRatio cannot be >= 1!");if(isNaN(r))throw new RangeError("totalStrokeDuration is NaN!");if(r<=0)throw new RangeError("totalStrokeDuration cannnot be <= 0!");if(!isFinite(r))throw new RangeError("totalStrokeDuration must be finite!")},i=(t,r)=>{const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttributeNS(null,"viewBox",t.viewBox),r.includeGrid&&e(n);const s=document.createElementNS("http://www.w3.org/2000/svg","g");null!==t.transform&&s.setAttributeNS(null,"transform",t.transform),n.appendChild(s);const o=[];for(let e=0;e<t.strokes.length;e+=1){const r=t.strokes[e],n=document.createElementNS("http://www.w3.org/2000/svg","path");if(n.setAttributeNS(null,"d",r.strokePath),null!==r.clipPath){const o=`${t.character}-${t.type}-clipPath-${e}`,i=document.createElementNS("http://www.w3.org/2000/svg","clipPath");i.setAttributeNS(null,"id",o),s.appendChild(i);const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttributeNS(null,"d",r.clipPath),i.appendChild(a),n.setAttributeNS(null,"clip-path",`url(#${o})`)}const i=`${t.character}-${t.type}-strokePath-${e}`;o.push(i),n.setAttributeNS(null,"id",i),n.setAttributeNS(null,"fill","none"),n.setAttributeNS(null,"stroke","#000"),n.setAttributeNS(null,"stroke-linecap","round"),n.setAttributeNS(null,"stroke-linejoin","round"),s.appendChild(n)}const i=((t,e,r)=>{const{strokeWidth:n,strokes:s}=t,{pauseRatio:o,totalStrokeDuration:i}=r,a=Math.min(s.length,e.length),u=document.createElementNS("http://www.w3.org/2000/svg","style"),l=[],h=i*a;for(let t=0;t<a;t+=1){const{strokePathLength:r}=s[t],u=e[t],c=t/a*100,p=(t+(1-o))/a*100,d=t*i;l.push(`@keyframes dash-${u}`),l.push("{"),d>0&&l.push(`0% { stroke-dasharray: 0 ${r}; }`),l.push(`${c}% { stroke-dasharray: 0 ${r}; animation-timing-function: linear; }`),p<100&&l.push(`${p}% { stroke-dasharray: ${r} 0; }`),l.push(`100% { stroke-dasharray: ${r} 0; }`),l.push("}"),l.push(`@keyframes width-${u}`),l.push("{"),d>0&&l.push("0% { stroke-width: 0; animation-timing-function: steps(1, end); }"),l.push(`${c}% { stroke-width: ${n}; }`),p<100&&l.push(`${p}% { stroke-width: ${n}; }`),l.push(`100% { stroke-width: ${n}; }`),l.push("}"),l.push(`#${u} { animation: dash-${u} ${h}s infinite, width-${u} ${h}s infinite; }`)}return u.appendChild(document.createTextNode(l.join(" "))),u})(t,o,r);return s.appendChild(i),n},a=(t,e,r)=>{const{strokes:n}=t,{pauseRatio:s,totalStrokeDuration:o}=e,{strokePathLength:i}=n[r],a=n.length,u=o*a,l=r/a,h=(r+(1-s))/a,c=[],p=[];r*o>0&&(c.push("0"),p.push(`0 ${i}`)),c.push(l.toString()),p.push(`0 ${i}`),h<1&&(c.push(h.toString()),p.push(`${i} 0`)),c.push("1"),p.push(`${i} 0`);const d=document.createElementNS("http://www.w3.org/2000/svg","animate");return d.setAttribute("attributeName","stroke-dasharray"),d.setAttribute("repeatCount","indefinite"),d.setAttribute("dur",u.toString()),d.setAttribute("calcMode","linear"),d.setAttribute("keyTimes",c.join(";")),d.setAttribute("values",p.join(";")),d},u=(t,e,r)=>{const{strokeWidth:n,strokes:s}=t,{pauseRatio:o,totalStrokeDuration:i}=e,a=s.length,u=i*a,l=r/a,h=(r+(1-o))/a,c=[],p=[];r*i>0&&(c.push("0"),p.push("0")),c.push(l.toString()),p.push(n.toString()),h<1&&(c.push(h.toString()),p.push(n.toString())),c.push("1"),p.push(n.toString());const d=document.createElementNS("http://www.w3.org/2000/svg","animate");return d.setAttribute("attributeName","stroke-width"),d.setAttribute("repeatCount","indefinite"),d.setAttribute("dur",u.toString()),d.setAttribute("calcMode","discrete"),d.setAttribute("keyTimes",c.join(";")),d.setAttribute("values",p.join(";")),d},l=(t,r)=>{const{character:n,strokes:s,transform:o,type:i,viewBox:l}=t,h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("xmlns","http://www.w3.org/2000/svg"),h.setAttributeNS(null,"viewBox",l),r.includeGrid&&e(h);const c=document.createElementNS("http://www.w3.org/2000/svg","g");null!==o&&c.setAttributeNS(null,"transform",o),h.appendChild(c);for(let e=0;e<s.length;e+=1){const{clipPath:o,strokePath:l}=s[e],h=document.createElementNS("http://www.w3.org/2000/svg","path");if(h.setAttributeNS(null,"d",l),null!==o){const t=`${n}-${i}-clipPath-${e}`;h.setAttributeNS(null,"clip-path",`url(#${t})`);const r=document.createElementNS("http://www.w3.org/2000/svg","clipPath");r.setAttributeNS(null,"id",t),c.appendChild(r);const s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttributeNS(null,"d",o),r.appendChild(s)}h.setAttributeNS(null,"fill","none"),h.setAttributeNS(null,"stroke","#000"),h.setAttributeNS(null,"stroke-linecap","round"),h.setAttributeNS(null,"stroke-linejoin","round"),h.appendChild(a(t,r,e)),h.appendChild(u(t,r,e)),c.appendChild(h)}return h},h=(t,e,r)=>{const a={includeGrid:void 0===r.includeGrid||r.includeGrid,pauseRatio:void 0===r.pauseRatio?.2:r.pauseRatio,totalStrokeDuration:void 0===r.totalStrokeDuration?1:r.totalStrokeDuration};o(a);const u=(t=>{switch(t){case"zh":return n;case"ja":return s;default:throw new Error("Unsupported type!")}})(t);switch(e){case"svg-css":return async t=>{const e=await u(t);return i(e,a)};case"svg-smil":case"svg":return async t=>{const e=await u(t);return l(e,a)};default:throw new Error("Unsupported output!")}},c=t=>{const e=document.createElement("img");return e.src=URL.createObjectURL(new Blob([(new XMLSerializer).serializeToString(t)],{type:"image/svg+xml"})),e};export{h as strokes,c as svgToImg};